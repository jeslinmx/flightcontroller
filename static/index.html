<html>
	<head>
		<script src='//cdnjs.cloudflare.com/ajax/libs/yepnope/1.5.4/yepnope.min.js'></script>
		<script>
			yepnope([
				{
					load: "//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1-rc2/jquery.min.js",
					complete: function() {
						if (!window.jQuery) yepnope('jquery.min.js');
					}
				},
				{
					load: "/primus/primus.js"
				},
				{
					load: "gyro.min.js",
					complete: function () {$(init)}
				}
			]);
			
			function init() {
				// // test for gyro support
				// var test = gyro.getOrientation()
				// if (!test.alpha && !test.beta && !test.gamma) {
				// 	applicationState = "gyroUnsupported";
				// 	return;
				// }
				// // test for websocket support
				// if (typeof(WebSocket) != "function") {
				// 	applicationState = "wsUnsupported";
				// 	return;
				// }

				applicationState = "unconnected"; // unconnected -> connected -> waiting -> active -> timeup; disconnected
				// let's go!
				var socket = Primus.connect('');

				t = {};

				socket.on('open', function() {
					// connected but not acknowledged
					applicationState = "connected";
				}).on('data', function(data) {
					if (data.statusUpdate) {
						switch (data.statusUpdate) {
							case "waiting": 
								applicationState = "waiting";
								break;
							case "active": 
								applicationState = "active";
								interval = setInterval(function() {
									var o = gyro.getOrientation();
									//o = {alpha: Math.random() * 360, beta: Math.random() * 360, gamma: Math.random() * 360, }
									socket.write([o.alpha.toFixed(1), o.beta.toFixed(1), o.gamma.toFixed(1)]);

									t[o.alpha.toFixed(1)] = performance.now()
								}, 100);
								break;
							case "timeup": 
								applicationState = "timeup";
								clearInterval(interval);
								break;
							default: applicationState = "disconnected";
						}
					}

					else {
						// ping measurement
						$("#latency").append((performance.now()-t[data[0]]) + " ");
					}
				}).on('reconnecting', function() {
					applicationState = "reconnecting";
				}).on('end', function() {
					// if connection is permanently dropped without a timeup, assume the server messed up
					if (applicationState != "timeup") {
						applicationState = "disconnected";
					}
				})


				// 'enqueued', function(data) {
				// 	applicationState = "waiting";
				// }).on('ready', function() {
				// 	applicationState = "active";
				// 	interval = setInterval(function() {
				// 		var o = gyro.getOrientation()
				// 		socket.emit('beep', o.alpha, o.beta, o.gamma);
				// 	}, 100);
				// }).on('timeup', function(data) {
				// 	applicationState = "timeup";
				// 	clearInterval(interval);
				// }).on('disconnect', function() {
				// 	if (applicationState != "timeup")
				// 		applicationState = "disconnected";
				// });
				
				gyro.frequency = 10;
				gyro.startTracking(function(o){
					$('#a').text(o.alpha);
					$('#b').text(o.beta);
					$('#g').text(o.gamma);
					$('#support').text(String(gyro.getFeatures()));
				});
			}
		</script>
	</head>
<body>
	<span id='support'></span>
	<br>
	<span id='a'></span>, <span id='b'></span>, <span id='g'></span>
	<span id='latency'></span>
</body>
</html>