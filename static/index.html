<html>
	<head>
		<script src='//cdnjs.cloudflare.com/ajax/libs/yepnope/1.5.4/yepnope.min.js'></script>
		<script>
			yepnope([
				{
					load: "//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1-rc2/jquery.min.js",
					complete: function() {
						if (!window.jQuery) yepnope('jquery.min.js');
					}
				},
				{
					load: "/primus/primus.js"
				},
				{
					load: "gyro.min.js",
					complete: function () {$(init)}
				}
			]);
			
			function init() {
				applicationState = "unconnected"; // unconnected -> connected -> waiting -> active -> timeup; disconnected
				var socket = Primus.connect('');
				socket.on('open', function() {
					applicationState = "connected";
				}).on('data', function(data) {
					if (data.statusUpdate) {
						switch (data.statusUpdate) {
							case "enqueued": 
								applicationState = "waiting";
								break;
							case "ready": 
								applicationState = "active";
								interval = setInterval(function() {
									var o = gyro.getOrientation()
									socket.write([o.alpha, o.beta, o.gamma]);
								}, 100);
								break;
							case "timeup": 
								applicationState = "timeup";
								clearInterval(interval);
								break;
							default: applicationState = "disconnected";
						}
					}
				}).on('reconnecting', function() {
					applicationState = "reconnecting";
				}).on('end', function() {
					if (applicationState != "timeup") {
						applicationState = "disconnected";
					}
				})


				// 'enqueued', function(data) {
				// 	applicationState = "waiting";
				// }).on('ready', function() {
				// 	applicationState = "active";
				// 	interval = setInterval(function() {
				// 		var o = gyro.getOrientation()
				// 		socket.emit('beep', o.alpha, o.beta, o.gamma);
				// 	}, 100);
				// }).on('timeup', function(data) {
				// 	applicationState = "timeup";
				// 	clearInterval(interval);
				// }).on('disconnect', function() {
				// 	if (applicationState != "timeup")
				// 		applicationState = "disconnected";
				// });
				
				gyro.frequency = 10;
				gyro.startTracking(function(o){
					$('#a').text(o.alpha);
					$('#b').text(o.beta);
					$('#g').text(o.gamma);
					$('#support').text(String(gyro.getFeatures()));
				});
			}
		</script>
	</head>
<body>
	<span id='support'></span>
	<br>
	<span id='a'></span>, <span id='b'></span>, <span id='g'></span>
</body>
</html>